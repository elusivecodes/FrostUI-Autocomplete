!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@fr0st/query"),require("@fr0st/ui")):"function"==typeof define&&define.amd?define(["exports","@fr0st/query","@fr0st/ui"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).UI=t.UI||{},t.fQuery,t.UI)}(this,(function(t,e,s){"use strict";class i extends s.BaseComponent{constructor(t,e){super(t,e),this._data=[],this._getData=null,this._getResults=null,this._options.getResults?(this._getResultsCallbackInit(),this._getResultsInit()):this._options.data&&(this._data=this._options.data,this._getDataInit()),this._render(),this._events()}dispose(){this._popper&&(this._popper.dispose(),this._popper=null),e.remove(this._menuNode),e.removeEvent(this._node,"keydown.ui.autocomplete"),e.removeEvent(this._node,"keyup.ui.autocomplete"),e.removeEvent(this._node,"input.ui.autocomplete"),e.removeEvent(this._node,"blur.ui.autocomplete"),e.removeAttribute(this._node,"role"),e.removeAttribute(this._node,"aria-controls"),e.removeAttribute(this._node,"aria-autocomplete"),e.removeAttribute(this._node,"aria-expanded"),e.removeAttribute(this._node,"aria-activedescendent"),this._menuNode=null,this._loader=null,this._error=null,this._data=null,this._value=null,this._requests=null,this._popperOptions=null,this._getData=null,this._getResults=null,super.dispose()}hide(){e.isConnected(this._menuNode)&&!e.getDataset(this._menuNode,"uiAnimating")&&e.triggerOne(this._node,"hide.ui.autocomplete")&&(e.setDataset(this._menuNode,{uiAnimating:"out"}),e.fadeOut(this._menuNode,{duration:this._options.duration}).then((t=>{this._popper.dispose(),this._popper=null,e.empty(this._menuNode),e.detach(this._menuNode),e.removeDataset(this._menuNode,"uiAnimating"),e.setAttribute(this._node,{"aria-expanded":!1,"aria-activedescendent":""}),e.triggerEvent(this._node,"hidden.ui.autocomplete")})).catch((t=>{"out"===e.getDataset(this._menuNode,"uiAnimating")&&e.removeDataset(this._menuNode,"uiAnimating")})))}show(){if(e.is(this._node,":disabled")||e.hasAttribute(this._node,"readonly")||e.isConnected(this._menuNode)||e.getDataset(this._menuNode,"uiAnimating")||!e.triggerOne(this._node,"show.ui.autocomplete"))return;const t=e.getValue(this._node);this._getData({term:t}),e.setDataset(this._menuNode,{uiAnimating:"in"}),this._options.appendTo?e.append(this._options.appendTo,this._menuNode):e.after(this._node,this._menuNode),this._popper=new s.Popper(this._menuNode,this._popperOptions),e.fadeIn(this._menuNode,{duration:this._options.duration}).then((t=>{e.removeDataset(this._menuNode,"uiAnimating"),e.setAttribute(this._node,{"aria-expanded":!0}),e.triggerEvent(this._node,"shown.ui.autocomplete")})).catch((t=>{"in"===e.getDataset(this._menuNode,"uiAnimating")&&e.removeDataset(this._menuNode,"uiAnimating")}))}toggle(){e.isConnected(this._menuNode)?this.hide():this.show()}update(){this._popper&&this._popper.update()}}i.defaults={lang:{error:"Error loading data.",loading:"Loading.."},data:null,getResults:null,getValue:t=>e._isString(t)?t:t.text,renderResult(t){return this._options.getValue(t)},sanitize:t=>e.sanitize(t),isMatch(t,s){const i=this._options.getValue(t),o=e._escapeRegExp(s),n=new RegExp(o,"i");if(n.test(i))return!0;const a=i.normalize("NFD").replace(/[\u0300-\u036f]/g,"");return n.test(a)},sortResults(t,e,s){const i=this._options.getValue(t).toLowerCase(),o=this._options.getValue(e).toLowerCase();if(s){const t=i.indexOf(s)-o.indexOf(s);if(t)return t}return i.localeCompare(o)},minSearch:1,debounceInput:250,duration:100,maxHeight:"250px",appendTo:null,fullWidth:!1,placement:"bottom",position:"start",fixed:!1,spacing:0,minContact:!1},i.classes={active:"active",focus:"focus",item:"autocomplete-item",items:"autocomplete-items",menu:"autocomplete-menu"};const o=i.prototype;o._events=function(){e.addEventDelegate(this._menuNode,"contextmenu.ui.autocomplete",'[data-ui-action="select"]',(t=>{t.preventDefault()})),e.addEventDelegate(this._menuNode,"mousedown.ui.autocomplete",'[data-ui-action="select"]',(t=>{t.preventDefault()})),e.addEvent(this._node,"blur.ui.autocomplete",(t=>{e.isSame(this._node,document.activeElement)||(e.stop(this._menuNode),e.removeDataset(this._menuNode,"uiAnimating"),this.hide())})),e.addEventDelegate(this._menuNode,"mouseup.ui.autocomplete",'[data-ui-action="select"]',(t=>{t.preventDefault();const s=e.getDataset(t.currentTarget,"uiValue");s!==e.getValue(this._node)&&(e.setValue(this._node,s),e.triggerEvent(this._node,"change.ui.autocomplete")),this.hide(),e.focus(this._node)})),e.addEventDelegate(this._menuNode,"mouseover.ui.autocomplete",'[data-ui-action="select"]',e.debounce((t=>{const s=e.find("[data-ui-focus]",this._menuNode);e.removeClass(s,this.constructor.classes.focus),e.removeDataset(s,"uiFocus"),e.addClass(t.currentTarget,this.constructor.classes.focus),e.setDataset(t.currentTarget,{uiFocus:!0});const i=e.getAttribute(t.currentTarget,"id");e.setAttribute(this._node,{"aria-activedescendent":i})}))),e.addEvent(this._node,"input.ui.autocomplete",e.debounce((t=>{this.show();const s=e.getValue(this._node);this._getData({term:s})}))),e.addEvent(this._node,"keydown.ui.autocomplete",(t=>{if(!["ArrowDown","ArrowUp","Enter"].includes(t.code))return;const s=e.findOne("[data-ui-focus]",this._menuNode);if("Enter"===t.code){if(s){const t=e.getDataset(s,"uiValue");t!==e.getValue(this._node)&&(e.setValue(this._node,t),e.triggerEvent(this._node,"change.ui.autocomplete")),this.hide()}return}if(t.preventDefault(),!e.isConnected(this._menuNode))return this.show();let i;if(s)switch(t.code){case"ArrowDown":i=e.nextAll(s,'[data-ui-action="select"]').shift();break;case"ArrowUp":i=e.prevAll(s,'[data-ui-action="select"]').pop()}else i=e.findOne('[data-ui-action="select"]',this._menuNode);if(!s&&!i&&!this._request){const t=e.getValue(this._node);return this._getData({term:t})}if(!i)return;e.removeClass(s,this.constructor.classes.focus),e.removeDataset(s,"uiFocus"),e.addClass(i,this.constructor.classes.focus),e.setDataset(i,{uiFocus:!0});const o=e.getAttribute(i,"id");e.setAttribute(this._node,{"aria-activedescendent":o});const n=e.getScrollY(this._menuNode),a=e.rect(this._menuNode,{offset:!0}),u=e.rect(i,{offset:!0});u.top<a.top?e.setScrollY(this._menuNode,n+u.top-a.top):u.bottom>a.bottom&&e.setScrollY(this._menuNode,n+u.bottom-a.bottom)})),e.addEvent(this._node,"keyup.ui.autocomplete",(t=>{"Escape"===t.code&&e.isConnected(this._menuNode)&&(t.stopPropagation(),this.hide())})),this._options.getResults&&e.addEvent(this._menuNode,"scroll.ui.autocomplete",e._throttle((t=>{if(this._loadingScroll||!this._showMore)return;const s=e.height(this._menuNode),i=e.height(this._menuNode,{boxSize:e.SCROLL_BOX});if(e.getScrollY(this._menuNode)>=i-s-s/4){const t=e.getValue(this._node),s=this._data.length;this._loadingScroll=!0,this._getData({term:t,offset:s})}}),250,{leading:!1}))},o._getDataInit=function(){this._getData=({term:t=null})=>{let s;if(e.empty(this._menuNode),e.setAttribute(this._node,{"aria-activedescendent":""}),this._options.minSearch&&(!t||t.length<this._options.minSearch))s=[];else{const e=this._options.isMatch.bind(this),i=this._options.sortResults.bind(this);s=this._data.filter((s=>e(s,t))).sort(((e,s)=>i(e,s,t)))}this._renderResults(s),this.update()}},o._getResultsCallbackInit=function(){this._getResults=t=>{t.offset||(this._data=[]);const e=Promise.resolve(this._options.getResults(t));return e.then((t=>{this._data.push(...t.results),this._showMore=t.showMore})).catch((t=>{})),e}},o._getResultsInit=function(){const t=e._debounce((({offset:t,term:s})=>{const i={offset:t};s&&(i.term=s);const o=this._getResults(i);o.then((s=>{this._request===o&&(t?this._loader&&e.detach(this._loader):e.empty(this._menuNode),this._renderResults(s.results),this._request=null)})).catch((t=>{this._request===o&&(e.detach(this._loader),e.append(this._menuNode,this._error),this._request=null)})).finally((t=>{this._loadingScroll=!1,this.update()})),this._request=o}),this._options.debounceInput);this._getData=({offset:s=0,term:i=null})=>{if(this._request&&this._request.cancel&&this._request.cancel(),this._request=null,s)e.detach(this._error);else{e.setAttribute(this._node,{"aria-activedescendent":""});const t=e.children(this._menuNode,(t=>!e.isSame(t,this._loader)));e.detach(t)}if(this._options.minSearch&&(!i||i.length<this._options.minSearch))return e.hide(this._menuNode),void this.update();e.show(this._menuNode);const o=e.child(this._menuNode,":last-child");o&&e.isSame(o,this._loader)||e.append(this._menuNode,this._loader),t({offset:s,term:i})}},o._render=function(){const t=s.generateId("autocomplete");this._menuNode=e.create("div",{class:this.constructor.classes.menu,style:{maxHeight:this._options.maxHeight},attributes:{id:t,role:"listbox"}}),this._options.getResults&&(this._loader=e.create("div",{class:this.constructor.classes.item,html:this._options.sanitize(this._options.lang.loading)}),this._error=e.create("div",{class:this.constructor.classes.item,text:this._options.sanitize(this._options.lang.error)})),this._popperOptions={reference:this._node,placement:this._options.placement,position:this._options.position,fixed:this._options.fixed,spacing:this._options.spacing,minContact:this._options.minContact},this._options.fullWidth&&(this._popperOptions.beforeUpdate=t=>{e.setStyle(t,{width:""})},this._popperOptions.afterUpdate=(t,s)=>{const i=e.width(s,{boxSize:e.BORDER_BOX});e.setStyle(t,{width:`${i}px`})}),e.setAttribute(this._node,{role:"combobox","aria-controls":t,"aria-autocomplete":"list","aria-expanded":!1,"aria-activedescendent":""})},o._renderItem=function(t){const i=s.generateId("autocomplete-item"),o=this._options.getValue(t),n=e.create("button",{class:this.constructor.classes.item,attributes:{id:i,type:"button",role:"option"},dataset:{uiAction:"select",uiValue:o}});e.getValue(this._node)===o&&e.addClass(n,this.constructor.classes.active);const a=this._options.renderResult.bind(this)(t,n);return e._isString(a)?e.setHTML(n,this._options.sanitize(a)):e._isElement(a)&&!e.isSame(n,a)&&e.append(n,a),n},o._renderResults=function(t){if(!t.length)return void e.hide(this._menuNode);e.show(this._menuNode);for(const s of t){const t=this._renderItem(s);e.append(this._menuNode,t)}if(e.findOne("[data-ui-focus]",this._menuNode))return;let s=e.findOne("[data-ui-active]",this._menuNode);if(s||(s=e.findOne('[data-ui-action="select"]',this._menuNode)),s){e.addClass(s,this.constructor.classes.focus),e.setDataset(s,{uiFocus:!0});const t=e.getAttribute(s,"id");e.setAttribute(this._node,{"aria-activedescendent":t})}},s.initComponent("autocomplete",i),t.Autocomplete=i}));