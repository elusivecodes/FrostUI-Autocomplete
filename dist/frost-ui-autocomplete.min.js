!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@fr0st/query"),require("@fr0st/ui")):"function"==typeof define&&define.amd?define(["exports","@fr0st/query","@fr0st/ui"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).UI=t.UI||{},t.fQuery,t.UI)}(this,(function(t,e,s){"use strict";class i extends s.BaseComponent{constructor(t,e){super(t,e),this._data=[],this._activeItems=[],this._getData=null,this._getResults=null,this._options.getResults?this._getResultsInit():this._options.data&&(this._data=this._options.data,this._getDataInit()),this._render(),this._events()}dispose(){this._popper&&(this._popper.dispose(),this._popper=null),e.remove(this._menuNode),e.removeEvent(this._node,"keydown.ui.autocomplete"),e.removeEvent(this._node,"keyup.ui.autocomplete"),e.removeEvent(this._node,"input.ui.autocomplete"),e.removeEvent(this._node,"blur.ui.autocomplete"),e.removeAttribute(this._node,"role"),e.removeAttribute(this._node,"aria-controls"),e.removeAttribute(this._node,"aria-autocomplete"),e.removeAttribute(this._node,"aria-expanded"),e.removeAttribute(this._node,"aria-activedescendent"),this._menuNode=null,this._loader=null,this._error=null,this._data=null,this._activeItems=null,this._value=null,this._requests=null,this._popperOptions=null,this._getData=null,super.dispose()}hide(){e.isConnected(this._menuNode)&&!e.getDataset(this._menuNode,"uiAnimating")&&e.triggerOne(this._node,"hide.ui.autocomplete")&&(e.setDataset(this._menuNode,{uiAnimating:"out"}),e.fadeOut(this._menuNode,{duration:this._options.duration}).then((t=>{this._popper.dispose(),this._popper=null,this._activeItems=[],e.empty(this._menuNode),e.detach(this._menuNode),e.removeDataset(this._menuNode,"uiAnimating"),e.setAttribute(this._node,{"aria-expanded":!1,"aria-activedescendent":""}),e.triggerEvent(this._node,"hidden.ui.autocomplete")})).catch((t=>{"out"===e.getDataset(this._menuNode,"uiAnimating")&&e.removeDataset(this._menuNode,"uiAnimating")})))}show(){if(e.is(this._node,":disabled")||e.hasAttribute(this._node,"readonly")||e.isConnected(this._menuNode)||e.getDataset(this._menuNode,"uiAnimating")||!e.triggerOne(this._node,"show.ui.autocomplete"))return;const t=e.getValue(this._node);this._getData({term:t}),e.setDataset(this._menuNode,{uiAnimating:"in"}),this._options.appendTo?e.append(this._options.appendTo,this._menuNode):e.after(this._node,this._menuNode),this._popper=new s.Popper(this._menuNode,this._popperOptions),e.fadeIn(this._menuNode,{duration:this._options.duration}).then((t=>{e.removeDataset(this._menuNode,"uiAnimating"),e.setAttribute(this._node,{"aria-expanded":!0}),e.triggerEvent(this._node,"shown.ui.autocomplete")})).catch((t=>{"in"===e.getDataset(this._menuNode,"uiAnimating")&&e.removeDataset(this._menuNode,"uiAnimating")}))}toggle(){e.isConnected(this._menuNode)?this.hide():this.show()}update(){this._popper&&this._popper.update()}}i.defaults={lang:{error:"Error loading data.",loading:"Loading.."},data:null,getResults:null,renderResult:t=>t,sanitize:t=>e.sanitize(t),isMatch(t,s){const i=e._escapeRegExp(s),o=new RegExp(i,"i");if(o.test(t))return!0;const n=t.normalize("NFD").replace(/[\u0300-\u036f]/g,"");return o.test(n)},sortResults(t,e,s){const i=t.toLowerCase(),o=e.toLowerCase();if(s){const t=i.indexOf(s)-o.indexOf(s);if(t)return t}return i.localeCompare(o)},minSearch:1,debounce:250,duration:100,maxHeight:"250px",menuSize:null,appendTo:null,fullWidth:!1,placement:"bottom",position:"start",fixed:!1,spacing:0,minContact:!1},i.classes={active:"active",focus:"focus",info:"autocomplete-item text-body-secondary",item:"autocomplete-item",menu:"autocomplete-menu list-unstyled",menuSmall:"autocomplete-menu-sm",menuLarge:"autocomplete-menu-lg"};const o=i.prototype;o._events=function(){e.addEventDelegate(this._menuNode,"contextmenu.ui.autocomplete",'[data-ui-action="select"]',(t=>{t.preventDefault()})),e.addEventDelegate(this._menuNode,"mousedown.ui.autocomplete",'[data-ui-action="select"]',(t=>{t.preventDefault()})),e.addEvent(this._node,"blur.ui.autocomplete",(t=>{e.isSame(this._node,document.activeElement)||(e.stop(this._menuNode),e.removeDataset(this._menuNode,"uiAnimating"),this.hide())})),e.addEventDelegate(this._menuNode,"click.ui.autocomplete",'[data-ui-action="select"]',(t=>{t.preventDefault();const s=e.getDataset(t.currentTarget,"uiValue");s!==e.getValue(this._node)&&(e.setValue(this._node,s),e.triggerEvent(this._node,"change.ui.autocomplete")),this.hide(),e.focus(this._node)})),e.addEventDelegate(this._menuNode,"mouseover.ui.autocomplete",'[data-ui-action="select"]',e.debounce((t=>{const s=e.findOne("[data-ui-focus]",this._menuNode);e.removeClass(s,this.constructor.classes.focus),e.removeDataset(s,"uiFocus"),e.addClass(t.currentTarget,this.constructor.classes.focus),e.setDataset(t.currentTarget,{uiFocus:!0});const i=e.getAttribute(t.currentTarget,"id");e.setAttribute(this._node,{"aria-activedescendent":i})}))),e.addEvent(this._node,"input.ui.autocomplete",e.debounce((t=>{if(e.isConnected(this._menuNode)){const t=e.getValue(this._node);this._getData({term:t})}else this.show()}))),e.addEvent(this._node,"keydown.ui.autocomplete",(t=>{if(!["ArrowDown","ArrowUp","Enter","NumpadEnter"].includes(t.code))return;const s=e.findOne("[data-ui-focus]",this._menuNode);switch(t.code){case"Enter":case"NumpadEnter":if(s){const t=e.getDataset(s,"uiValue");t!==e.getValue(this._node)&&(e.setValue(this._node,t),e.triggerEvent(this._node,"change.ui.autocomplete")),this.hide()}return}if(t.preventDefault(),!e.isConnected(this._menuNode))return void this.show();let i;if(s){let e=this._activeItems.indexOf(s);switch(t.code){case"ArrowDown":e++;break;case"ArrowUp":e--}i=this._activeItems[e]}else i=this._activeItems[0];if(!s&&!i&&!this._request){const t=e.getValue(this._node);return void this._getData({term:t})}if(!i)return;e.removeClass(s,this.constructor.classes.focus),e.removeDataset(s,"uiFocus"),e.addClass(i,this.constructor.classes.focus),e.setDataset(i,{uiFocus:!0});const o=e.getAttribute(i,"id");e.setAttribute(this._node,{"aria-activedescendent":o});const n=e.getScrollY(this._menuNode),a=e.rect(this._menuNode,{offset:!0}),u=e.rect(i,{offset:!0});u.top<a.top?e.setScrollY(this._menuNode,n+u.top-a.top):u.bottom>a.bottom&&e.setScrollY(this._menuNode,n+u.bottom-a.bottom)})),e.addEvent(this._node,"keyup.ui.autocomplete",(t=>{"Escape"===t.code&&e.isConnected(this._menuNode)&&(t.stopPropagation(),this.hide())})),this._options.getResults&&e.addEvent(this._menuNode,"scroll.ui.autocomplete",e._throttle((t=>{if(this._loadingScroll||!this._showMore)return;const s=e.height(this._menuNode),i=e.height(this._menuNode,{boxSize:e.SCROLL_BOX});if(e.getScrollY(this._menuNode)>=i-s-s/4){const t=e.getValue(this._node),s=this._data.length;this._loadingScroll=!0,this._getData({term:t,offset:s})}}),250,{leading:!1}))},o._getDataInit=function(){this._getData=({term:t=null})=>{if(this._activeItems=[],e.empty(this._menuNode),e.setAttribute(this._node,{"aria-activedescendent":""}),this._options.minSearch&&(!t||t.length<this._options.minSearch))return e.hide(this._menuNode),void this.update();e.show(this._menuNode);const s=this._options.isMatch.bind(this),i=this._options.sortResults.bind(this),o=this._data.filter((e=>s(e,t))).sort(((e,s)=>i(e,s,t)));this._renderResults(o),this.update()}},o._getResultsInit=function(){const t=e._debounce((({offset:t,term:s})=>{const i={offset:t};s&&(i.term=s);const o=Promise.resolve(this._options.getResults(i));o.then((s=>{if(this._request!==o)return;const i=s.results;t?(this._data.push(...i),e.detach(this._loader)):(this._data=i,e.empty(this._menuNode)),this._showMore=s.showMore,this._renderResults(i),this._request=null})).catch((t=>{this._request===o&&(e.detach(this._loader),e.append(this._menuNode,this._error),this._request=null)})).finally((t=>{this._loadingScroll=!1,this.update()})),this._request=o}),this._options.debounce);this._getData=({offset:s=0,term:i=null})=>{if(this._request&&this._request.cancel&&this._request.cancel(),this._request=null,s)e.detach(this._error);else{this._activeItems=[],e.setAttribute(this._node,{"aria-activedescendent":""});const t=e.children(this._menuNode,(t=>!e.isSame(t,this._loader)));e.detach(t)}if(this._options.minSearch&&(!i||i.length<this._options.minSearch))return e.hide(this._menuNode),void this.update();e.show(this._menuNode);const o=e.child(this._menuNode,":last-child");o&&e.isSame(o,this._loader)||e.append(this._menuNode,this._loader),t({offset:s,term:i})}},o._render=function(){const t=s.generateId("autocomplete");this._menuNode=e.create("ul",{class:this.constructor.classes.menu,style:{maxHeight:this._options.maxHeight},attributes:{id:t,role:"listbox"}}),e.is(this._node,".input-sm")?e.addClass(this._menuNode,this.constructor.classes.menuSmall):e.is(this._node,".input-lg")&&e.addClass(this._menuNode,this.constructor.classes.menuLarge),this._options.getResults&&(this._loader=this._renderInfo(this._options.lang.loading),this._error=this._renderInfo(this._options.lang.error)),this._popperOptions={reference:this._node,placement:this._options.placement,position:this._options.position,fixed:this._options.fixed,spacing:this._options.spacing,minContact:this._options.minContact},this._options.fullWidth&&(this._popperOptions.beforeUpdate=t=>{e.setStyle(t,{width:""})},this._popperOptions.afterUpdate=(t,s)=>{const i=e.width(s,{boxSize:e.BORDER_BOX});e.setStyle(t,{width:`${i}px`})}),e.setAttribute(this._node,{role:"combobox","aria-controls":t,"aria-autocomplete":"list","aria-expanded":!1,"aria-activedescendent":""})},o._renderInfo=function(t){return e.create("div",{html:this._options.sanitize(t),class:this.constructor.classes.info})},o._renderItem=function(t){const i=s.generateId("autocomplete-item"),o=e.getValue(this._node)==t,n=e.create("li",{class:this.constructor.classes.item,attributes:{id:i,role:"option","aria-label":t,"aria-selected":o},dataset:{uiAction:"select",uiValue:t}});this._activeItems.push(n),o&&e.addClass(n,this.constructor.classes.active);const a=this._options.renderResult.bind(this)(t,n);return e._isString(a)?e.setHTML(n,this._options.sanitize(a)):e._isElement(a)&&!e.isSame(n,a)&&e.append(n,a),n},o._renderResults=function(t){e.show(this._menuNode);for(const s of t){const t=this._renderItem(s);e.append(this._menuNode,t)}if(e.hasChildren(this._menuNode)){if(!e.findOne("[data-ui-focus]",this._menuNode)&&this._activeItems.length){const t=this._activeItems[0];e.addClass(t,this.constructor.classes.focus),e.setDataset(t,{uiFocus:!0});const s=e.getAttribute(t,"id");e.setAttribute(this._node,{"aria-activedescendent":s})}}else e.hide(this._menuNode)},s.initComponent("autocomplete",i),t.Autocomplete=i}));